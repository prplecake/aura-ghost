image: alpine/edge
packages:
  - npm
  - aws-cli
  - zip
secrets:
  - cd2e1b97-e567-47ee-95e9-b4a4894011b3
sources:
  - https://git.sr.ht/~mjorgensen/aura
tasks:
  - init: |
      sudo npm install -g gscan
  - gscan: |
      gscan aura
  - dist: |
      cd aura
      git rev-parse --abbrev-ref HEAD
      LATEST_TAG=$(git describe --tags --always --abbrev=0)
      FILENAME=latest
      if [ "$(git rev-parse origin/develop)" == "$(git rev-parse HEAD)" ]; then
        FILENAME=dev
      elif [ "$(git rev-parse master)" != "$(git rev-parse HEAD)" ]; then
        complete-build;
      elif [ "$(git describe)" == "$LATEST_TAG" ]; then
        FILENAME=$LATEST_TAG
      fi
      cd ../
      zip -r aura-$FILENAME.zip aura --exclude "*/.git*"
      aws s3 cp aura-$FILENAME.zip s3://files.splat.soy/dist/aura/